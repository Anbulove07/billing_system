  <!doctype html>
        <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>Billing - Page 1</title>
          <script src="/static/billing.js"></script>
          <style>
            body{font-family: Arial, sans-serif; padding:20px}
            .product_row{margin-bottom:8px}
            label{display:inline-block; margin-right:10px}
          </style>
        </head>
        <body>
          <h1>Billing</h1>
          <form method="post" action="/generate">
            <label>Customer Email: <input type="email" name="customer_email" required></label>

            <h3>Products</h3>
            <div id="products_container">
              <div class="product_row">
                <select name="product_code_1">
                  <option value="">-- select --</option>
                  {% for p in products %}
                  <option value="{{p.product_id}}">{{p.name}} ({{p.product_id}}) - {{p.price_per_unit}}</option>
                  {% endfor %}
                </select>
                <input type="number" name="qty_1" min="1" value="1">
              </div>
            </div>
            <button type="button" onclick="addProductRow()">Add New</button>

            <h3>Shop Denominations (current counts)</h3>
            <div id="denoms">
              {% for d in denominations %}
                <label>{{d.value}} : <input type="number" name="denom_count_{{d.value}}" value="{{d.count}}" min="0"></label>
              {% endfor %}
            </div>

            <div style="margin-top:12px">
              <label>Paid Amount: <input type="number" step="0.01" name="paid_amount" required></label>
            </div>

            <div style="margin-top:12px">
              <button type="submit">Generate Bill</button>
            </div>
          </form>

          <hr>
          <h3>View previous purchases by customer</h3>
          <input type="email" id="history_email" placeholder="Enter customer email">
          <button onclick="viewHistory()">View</button>
          <div id="history_result"></div>

          <script>
            async function viewHistory(){
              const email = document.getElementById('history_email').value
              if(!email) return alert('Enter email')
              const res = await fetch(`/history/${encodeURIComponent(email)}`)
              const data = await res.json()
              const div = document.getElementById('history_result')
              if(data.length===0){ div.innerHTML = '<p>No purchases found</p>'; return }
              let html = '<ul>'
              for(const p of data){
                html += `<li>Purchase #${p.id} — ${p.timestamp} — Total: ${p.total} — Paid: ${p.paid} <button onclick="viewItems(${p.id})">View Items</button></li>`
              }
              html += '</ul>'
              div.innerHTML = html
            }
            async function viewItems(id){
              const res = await fetch(`/purchase/${id}`)
              const data = await res.json()
              let html = '<ul>'
              for(const it of data){ html += `<li>${it.product_code} x ${it.qty} — ${it.line_total}</li>` }
              html += '</ul>'
              alert(html)
            }
          </script>
        </body>
        </html>
